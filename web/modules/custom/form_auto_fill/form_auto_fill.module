<?php

/**
 * @file
 * Contains form_auto_fill.module..
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_prepare_form().
 *
 * Randomly fills each required field with a random value. For file fields,
 * use default objects provided by the module.
 * The random filling, skips all entity keys except from the label as they
 * should not be handled within the form.
 */
function form_auto_fill_entity_prepare_form(EntityInterface $entity, $operation, FormStateInterface $form_state) {
  if (!$entity->isNew()) {
    return;
  }
  $settings = \Drupal::config('form_auto_fill.settings');

  // If the auto fill is disabled, return.
  if ($settings->get('activate_auto_fill') == FALSE) {
    return;
  }

  if ($settings->get('manual_fill') == FALSE) {
    form_auto_fill_entity_fill($entity);
  }
}

/**
 * Fills the entity with random values and passes it back to the form state.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *    The entity to be filled.
 *
 * @return EntityInterface
 *    The updated entity.
 */
function form_auto_fill_entity_fill(EntityInterface $entity) {
  $settings = \Drupal::config('form_auto_fill.settings');

  // Skip fields handled by core (label will still be filled later on).
  $keys_to_skip = $entity->getEntityType()->getKeys();
  $auto_fill_types = $settings->get('fields_to_fill');

  if (in_array('label', $auto_fill_types)) {
    $entity->label->generateSampleItems();
  }

  $field_definitions = $entity->getFieldDefinitions();
  foreach ($field_definitions as $id => $field_definition) {
    if (in_array($id, $keys_to_skip)) {
      continue;
    }

    if ($field_definition->isRequired() && in_array('required', $auto_fill_types)) {
      $entity->{$id}->generateSampleItems();
    }
    elseif ((!$field_definition->isRequired()) && in_array('optional', $auto_fill_types)) {
      $entity->{$id}->generateSampleItems();
    }
  }

  return $entity;
}
